# Citrusleaf Tools
# Makefile:  Large Stack Objects (LStack)

DIR_OBJECT = ./obj
DIR_HEADERS = ./include
DIR_TARGET = .
DIR_LIB = ../../target/Linux-x86_64/lib

SOURCES = lstack_config.c log.c lstack_counter.c lstack_main.c lstack_test.c run_tests.c
SOURCE_HEADERS = log.h lstack_config.h lstack_counter.h lstack_test.h
TARGET        = lstack

INCLUDES = -I./include -I../include -I../../target/Linux-x86_64/include/ 

AS_CFLAGS = -D_FILE_OFFSET_BITS=64 -std=gnu99 -D_REENTRANT -D_GNU_SOURCE
CFLAGS_NATIVE = -g  -fno-common -fno-strict-aliasing -rdynamic  -Wall -Wredundant-decls $(AS_CFLAGS)

CFLAGS = $(CFLAGS_NATIVE) $(INCLUDES)

LIBRARIES = $(DIR_LIB)/libcitrusleaf.a  -lssl -lcrypto -lpthread -lrt
ifeq (${MR_LANG},LUA)
LIBRARIES += -llua
endif
LIBRARIES += -lm

LDFLAGS += -L$(DEPTH)/lib/ -L$(DEPTH)/shared/lib/ 

# OBJECTS = $(SOURCES:%.c=$(DIR_OBJECT)/%.o)
OBJECTS = lstack_config.o log.o lstack_counter.o lstack_main.o lstack_test.o run_tests.o
DEPENDENCIES = $(OBJECTS:%.o=%.d) 

.PHONY: all
all: lstack

.PHONY: clean
clean:
	/bin/rm -f $(OBJECTS) $(DIR_TARGET)/$(TARGET)

.PHONY: depclean
depclean: clean
	/bin/rm -f $(DEPENDENCIES) 

.PHONY: $(TARGET)
$(TARGET): $(OBJECTS)
	$(CC) $(LDFLAGS) -o $(DIR_TARGET)/$(TARGET) $(OBJECTS) $(LIBRARIES)

-include $(DEPENDENCIES) 

$(DIR_OBJECT)/%.o:%.c | prepare
	$(CC) $(CFLAGS_NATIVE) -MMD -o $@ -c $(INCLUDES) $<

prepare:
	mkdir -p $(DIR_OBJECT)
