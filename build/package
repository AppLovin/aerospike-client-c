#!/bin/sh
# Package a specified version.

cd `dirname $0`

platform=`./parse_platform`

if [ $? -ne 0 ]
then
  echo "Invalid platform."
  exit 1
fi

if [ $platform = "el5" ] || [ $platform = "el6" ]
then 
  rpm=true
else
  rpm=false
fi

# Build package for header and library installation.
rev=`./version`
packageName=aerospike-client-c-$rev.$platform.x86_64
dist=/tmp/$packageName
build=$dist/BUILD

rm -f *.tgz
rm -rf $dist

mkdir -p $build/usr/include
mkdir -p $build/usr/lib

cp -r ../aerospike/target/Linux-x86_64/include $build/usr
cp ../aerospike/target/Linux-x86_64/lib/* $build/usr/lib

if $rpm
then
  rev=`echo $rev | sed 's/-/_/g'`
  spec=/tmp/client_v.spec
  sed 's/@VERSION@/'$rev'/g' < rpm/client.spec > $spec
  rpmbuild -bb -vv --buildroot $build $spec
  rm $spec
  pkg=~/rpmbuild/RPMS/x86_64/aerospike-client-c-$rev*.rpm
else
  mkdir -p $build/DEBIAN
  sed 's/@VERSION@/'$rev'/g' < deb/client.spec > $build/DEBIAN/control
  install -m 755 deb/postinst.client $build/DEBIAN/postinst
  pkg=deb/$packageName.deb
  fakeroot dpkg-deb --build $build $pkg
fi

# Build examples source code package.
./prepare_examples $dist
mv $pkg $dist

tar cf - -C /tmp $packageName | gzip -c > $packageName.tgz
rm -rf $dist

