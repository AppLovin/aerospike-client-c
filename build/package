#!/bin/sh
# Package a specified version.

cd `dirname $0`

platform=`./parse_platform`

if [ $? -ne 0 ]
then
  echo "Invalid platform."
  exit 1
fi

rev=`./version`
packageName=aerospike-client-c-$rev.$platform.x86_64
dist=/tmp/$packageName
build=$dist/BUILD

if [ $platform = "el5" ] || [ $platform = "el6" ]
then 
  rpm=true
  rev=`echo $rev | sed 's/-/_/g'`
  spec=/tmp/client_v.spec
else
  rpm=false
fi

# Cleanup previous packages.
rm -f *.tgz
rm -rf $dist

# Create library package.
mkdir -p $build/usr/lib
cp ../aerospike/target/Linux-x86_64/lib/* $build/usr/lib

if $rpm
then
  sed 's/@VERSION@/'$rev'/g' < rpm/client.spec > $spec
  rpmbuild -bb --buildroot $build $spec
  rm $spec
  pkg=~/rpmbuild/RPMS/x86_64/aerospike-client-c-$rev*.rpm
else
  mkdir -p $build/DEBIAN
  sed 's/@VERSION@/'$rev'/g' < deb/client.spec > $build/DEBIAN/control
  install -m 755 deb/postinst.client $build/DEBIAN/postinst
  pkg=deb/$packageName.deb
  fakeroot dpkg-deb --build $build $pkg
fi

# Create development package.
mkdir -p $build/usr/lib
cp ../aerospike/target/Linux-x86_64/lib/* $build/usr/lib
mkdir -p $build/usr/include
cp -r ../aerospike/target/Linux-x86_64/include $build/usr

if $rpm
then
  sed 's/@VERSION@/'$rev'/g' < rpm/client_devel.spec > $spec
  rpmbuild -bb --buildroot $build $spec
  rm $spec
  pkgDevel=~/rpmbuild/RPMS/x86_64/aerospike-client-c-devel-$rev*.rpm
else
  mkdir -p $build/DEBIAN
  sed 's/@VERSION@/'$rev'/g' < deb/client.spec > $build/DEBIAN/control
  install -m 755 deb/postinst.client $build/DEBIAN/postinst
  pkg=deb/$packageName.deb
  fakeroot dpkg-deb --build $build $pkg
fi

# Build api docs and examples source code package.
./prepare_examples $dist
mv $pkg $dist
mv $pkgDevel $dist
mkdir $dist/docs
cp -r ../aerospike/target/apidocs/html/* $dist/docs

echo $packageName
tar cf - -C /tmp $packageName | gzip -c > $packageName.tgz
rm -rf $dist

