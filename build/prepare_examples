#!/bin/sh
# Build examples source code package.

cd `dirname $0`
target=${1-.}

# Create examples.
srcExamplesDir=../aerospike/examples
trgExamplesDir=$target/examples

mkdir -p $trgExamplesDir
cp $srcExamplesDir/Makefile $trgExamplesDir
cp $srcExamplesDir/README.md $trgExamplesDir
cp -r $srcExamplesDir/utils $trgExamplesDir

for i in $srcExamplesDir/basic_examples/*/Makefile $srcExamplesDir/query_examples/*/Makefile $srcExamplesDir/scan_examples/{background,standard}/Makefile
do
	dir=`dirname $i`
	example=`basename $dir`
	dir=`dirname $dir`
	exampleType=`basename $dir`
	
	mkdir -p $trgExamplesDir/$exampleType
	cp $srcExamplesDir/$exampleType/Makefile $trgExamplesDir/$exampleType
	cp -r $srcExamplesDir/$exampleType/$example $trgExamplesDir/$exampleType
	rm -rf $trgExamplesDir/$exampleType/$example/target

	# Modify Makefile for external use.
	awk 'BEGIN{OFS=""}
	{
		if (index($0,"AEROSPIKE") > 0)
		{
			idx = index($0,"$(AEROSPIKE)/target/Linux-x86_64/lib/libaerospike.a")

			if (idx > 0)
			{
				# Use extra space in lib to compensate for incompatibility
				# between centos gawk and debian mawk.
				print substr($0, 0, idx-1)," /usr/lib/libaerospike.a"
			}
		}
		else
		{
			print $0
		}
	}' $i > $trgExamplesDir/$exampleType/$example/Makefile
done

